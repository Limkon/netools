name: Windows Build (Robust Split)

on: workflow_dispatch

env:
  QT_VERSION: '6.5.0'
  QT_ARCH: 'win64_msvc2019_64'
  # 【修正点1】将目录改到工作区内部，避免 "../" 造成的路径问题
  QT_INSTALL_DIR: '${{ github.workspace }}/Qt'

jobs:
  # --- 第一阶段：缓存预热 (Cache Warmer) ---
  prepare-dependencies:
    runs-on: windows-latest
    steps:
      - name: Compute Cache Key
        id: cache-key
        shell: powershell
        run: |
          echo "key=qt-${{ env.QT_VERSION }}-${{ env.QT_ARCH }}" >> $env:GITHUB_OUTPUT

      - name: Restore Qt Cache
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ env.QT_INSTALL_DIR }}
          key: ${{ steps.cache-key.outputs.key }}

      - name: Install Qt (If Cache Miss)
        if: steps.cache-qt.outputs.cache-hit != 'true'
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: 'windows'
          target: 'desktop'
          arch: ${{ env.QT_ARCH }}
          dir: ${{ env.QT_INSTALL_DIR }}
          cache: 'false'
          setup-python: 'false' 

  # --- 第二阶段：构建应用 (Build) ---
  build-application:
    needs: prepare-dependencies
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Compute Cache Key
      id: cache-key
      shell: powershell
      run: |
        echo "key=qt-${{ env.QT_VERSION }}-${{ env.QT_ARCH }}" >> $env:GITHUB_OUTPUT

    # 【修正点2】尝试恢复缓存，但删除了 fail-on-cache-miss: true
    - name: Restore Qt Cache
      id: cache-qt
      uses: actions/cache@v4
      with:
        path: ${{ env.QT_INSTALL_DIR }}
        key: ${{ steps.cache-key.outputs.key }}

    # 【修正点3】容错机制：如果 Job 2 没读到缓存（无论是因为 Job 1 失败还是网络问题），这里会自动补装
    # 这样保证了构建永远不会因为“缓存找不到”而失败
    - name: Install Qt (Fallback)
      if: steps.cache-qt.outputs.cache-hit != 'true'
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: ${{ env.QT_ARCH }}
        dir: ${{ env.QT_INSTALL_DIR }}
        cache: 'false'
        setup-python: 'false'

    - name: Setup Qt Environment
      shell: powershell
      run: |
        $qtPath = "${{ env.QT_INSTALL_DIR }}\Qt\${{ env.QT_VERSION }}\msvc2019_64"
        echo "Qt6_DIR=$qtPath" >> $env:GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=$qtPath" >> $env:GITHUB_ENV
        echo "$qtPath\bin" >> $env:GITHUB_PATH

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: NetToolPro-Windows-Release
        path: build/Release/NetToolPro.exe
